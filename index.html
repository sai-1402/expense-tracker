<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker Pro</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />

    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* light gray background */
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .nav-item.active {
            background-color: #ede9fe; /* violet-100 */
            color: #6d28d9; /* violet-700 */
            font-weight: 600;
        }
        .nav-item.active .material-symbols-outlined {
            font-variation-settings: 'FILL' 1;
        }
        /* Custom animation for the scanner */
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        .scan-overlay-animation {
            animation: pulse 2s infinite;
        }
        /* Hide scrollbar but allow scrolling */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* Page transition styles */
        .page {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .page.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="app-container" class="flex h-screen w-full">
        <!-- Sidebar Navigation -->
        <nav class="w-20 lg:w-64 bg-white border-r border-slate-200 flex flex-col">
            <div class="flex items-center justify-center lg:justify-start gap-3 h-16 border-b border-slate-200 px-6">
                <span class="material-symbols-outlined text-3xl text-violet-600">account_balance_wallet</span>
                <span class="text-xl font-bold text-slate-800 hidden lg:block">FinTrack</span>
            </div>
            <ul class="flex-1 py-4 flex flex-col gap-2 px-4">
                <li><a href="#" onclick="showPage('home')" class="nav-item flex items-center gap-4 p-3 rounded-lg hover:bg-slate-100 transition-colors duration-200">
                    <span class="material-symbols-outlined">home</span>
                    <span class="hidden lg:block">Home</span>
                </a></li>
                <li><a href="#" onclick="showPage('add')" class="nav-item flex items-center gap-4 p-3 rounded-lg hover:bg-slate-100 transition-colors duration-200">
                    <span class="material-symbols-outlined">add_circle</span>
                    <span class="hidden lg:block">Add Transaction</span>
                </a></li>
                <li><a href="#" onclick="showPage('scan')" class="nav-item flex items-center gap-4 p-3 rounded-lg hover:bg-slate-100 transition-colors duration-200">
                    <span class="material-symbols-outlined">qr_code_scanner</span>
                    <span class="hidden lg:block">Scan Receipt</span>
                </a></li>
                 <li><a href="#" onclick="showPage('budget')" class="nav-item flex items-center gap-4 p-3 rounded-lg hover:bg-slate-100 transition-colors duration-200">
                    <span class="material-symbols-outlined">savings</span>
                    <span class="hidden lg:block">Budgets</span>
                </a></li>
            </ul>
            <div id="user-info" class="border-t border-slate-200 p-4">
                 <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-violet-100 flex items-center justify-center">
                        <span class="material-symbols-outlined text-violet-600">person</span>
                    </div>
                    <div class="hidden lg:block">
                        <p class="text-sm font-semibold">User ID</p>
                        <p id="userIdDisplay" class="text-xs text-slate-500 break-all">loading...</p>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-screen">
             <!-- Header -->
            <header class="flex items-center justify-between h-16 bg-white border-b border-slate-200 px-6">
                <h1 id="page-title" class="text-xl font-bold text-slate-800">Home</h1>
                <button onclick="showPage('add')" class="flex lg:hidden items-center justify-center w-10 h-10 bg-violet-600 text-white rounded-full shadow-md hover:bg-violet-700 transition-colors">
                    <span class="material-symbols-outlined">add</span>
                </button>
            </header>
            
            <div id="content-area" class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8">
                <!-- Pages will be injected here -->
                <div id="home-page" class="page"></div>
                <div id="add-page" class="page"></div>
                <div id="scan-page" class="page"></div>
                <div id="budget-page" class="page"></div>
            </div>
        </main>
    </div>
    
    <!-- Modal for notifications -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 animate-fadeIn">
           <!-- Modal content will be injected here -->
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, getDocs, onSnapshot, query, where, writeBatch, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONFIG & INITIALIZATION ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'expense-tracker-pro';
        
        let app, auth, db, userId;
        let transactions = [];
        let budgets = {};
        
        const CATEGORIES = {
            'Food': { icon: '🍽️', type: 'expense' },
            'Transport': { icon: '🚗', type: 'expense' },
            'Shopping': { icon: '🛍️', type: 'expense' },
            'Health': { icon: '🏥', type: 'expense' },
            'Entertainment': { icon: '🎬', type: 'expense' },
            'Bills': { icon: '📱', type: 'expense' },
            'Salary': { icon: '💰', type: 'income' },
            'Other': { icon: '❓', type: 'expense' }
        };

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await setPersistence(auth, browserLocalPersistence);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userIdDisplay').textContent = userId;
                        await setupInitialData();
                        setupListeners();
                        showPage('home'); // Show home page after login and setup
                    } else {
                        // If no user, try to sign in
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                document.getElementById('content-area').innerHTML = `<div class="text-red-500">Error connecting to the database. Please check console.</div>`;
            }
        }

        async function setupInitialData() {
            // Check if budgets are already set up for this user
            const budgetsPath = `/artifacts/${appId}/users/${userId}/budgets`;
            const budgetsQuery = query(collection(db, budgetsPath));
            const budgetSnapshot = await getDocs(budgetsQuery);

            if (budgetSnapshot.empty) {
                // First time user, create default budgets
                const batch = writeBatch(db);
                const defaultBudgets = {
                    'Food': 50000,
                    'Transport': 20000,
                    'Shopping': 30000,
                    'Entertainment': 15000,
                    'Bills': 40000,
                };
                Object.entries(defaultBudgets).forEach(([name, amount]) => {
                    const budgetRef = doc(collection(db, budgetsPath));
                    batch.set(budgetRef, { name, amount });
                });
                await batch.commit();
            }
        }
        
        function setupListeners() {
            // Listen for transaction changes
            const transactionsPath = `/artifacts/${appId}/users/${userId}/transactions`;
            const qTransactions = query(collection(db, transactionsPath));
            onSnapshot(qTransactions, (snapshot) => {
                transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Sort by date, newest first
                transactions.sort((a, b) => b.date.toMillis() - a.date.toMillis());
                renderAllPages();
            }, (error) => console.error("Error listening to transactions:", error));

            // Listen for budget changes
            const budgetsPath = `/artifacts/${appId}/users/${userId}/budgets`;
            const qBudgets = query(collection(db, budgetsPath));
            onSnapshot(qBudgets, (snapshot) => {
                budgets = {};
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    budgets[data.name] = { id: doc.id, ...data };
                });
                renderAllPages();
            }, (error) => console.error("Error listening to budgets:", error));
        }

        function renderAllPages() {
             // Re-render the content of the currently active page to reflect data changes
            const activePageId = document.querySelector('.page.active')?.id;
            if (activePageId) {
                const pageName = activePageId.replace('-page', '');
                window.showPage(pageName);
            }
        }

        // --- PAGE RENDERING ---
        function renderHomePage() {
            const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const balance = income - expenses;

            const transactionListHTML = transactions.length > 0 ? transactions.map(t => `
                <div class="flex items-center gap-4 p-4 bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow">
                    <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-2xl">${CATEGORIES[t.category]?.icon || '❓'}</div>
                    <div class="flex-1">
                        <p class="font-semibold">${t.description}</p>
                        <p class="text-sm text-slate-500">${t.category} &middot; ${t.date.toDate().toLocaleDateString()}</p>
                    </div>
                    <p class="font-bold text-lg ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                        ${t.type === 'income' ? '+' : '-'}${t.amount.toLocaleString()}
                    </p>
                </div>
            `).join('') : '<p class="text-center text-slate-500 py-8">No transactions yet. Add one to get started!</p>';

            document.getElementById('home-page').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="text-slate-500 font-medium">Total Income</h3>
                        <p class="text-3xl font-bold text-green-600 mt-2">+${income.toLocaleString()}</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="text-slate-500 font-medium">Total Expenses</h3>
                        <p class="text-3xl font-bold text-red-600 mt-2">-${expenses.toLocaleString()}</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="text-slate-500 font-medium">Net Balance</h3>
                        <p class="text-3xl font-bold text-slate-800 mt-2">${balance.toLocaleString()}</p>
                    </div>
                </div>
                <h2 class="text-2xl font-bold mb-4">Recent Transactions</h2>
                <div class="space-y-4">${transactionListHTML}</div>
            `;
        }
        
        function renderAddPage(prefill = {}) {
            const categoryOptionsHTML = Object.entries(CATEGORIES).map(([name, data]) => `
                <label class="category-item flex flex-col items-center justify-center gap-2 p-3 border-2 border-slate-200 rounded-lg cursor-pointer transition-colors has-[:checked]:bg-violet-50 has-[:checked]:border-violet-400">
                    <input type="radio" name="category" value="${name}" class="sr-only" ${prefill.category === name ? 'checked' : ''}>
                    <span class="text-3xl">${data.icon}</span>
                    <span class="text-sm font-medium">${name}</span>
                </label>
            `).join('');
            
            document.getElementById('add-page').innerHTML = `
                <div class="max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-sm">
                    <form id="add-transaction-form">
                        <div class="mb-6">
                            <label for="amount" class="block text-sm font-medium text-slate-700 mb-2">Amount</label>
                            <input type="number" id="amount" name="amount" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-violet-500 transition" placeholder="0.00" value="${prefill.amount || ''}" required>
                        </div>
                        <div class="mb-6">
                            <label for="description" class="block text-sm font-medium text-slate-700 mb-2">Description</label>
                            <input type="text" id="description" name="description" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-violet-500 transition" placeholder="e.g., Lunch with team" value="${prefill.description || ''}" required>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-slate-700 mb-2">Category</label>
                            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">${categoryOptionsHTML}</div>
                        </div>
                        <div class="mb-8">
                            <label for="date" class="block text-sm font-medium text-slate-700 mb-2">Date</label>
                            <input type="date" id="date" name="date" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-violet-500 transition" value="${prefill.date || new Date().toISOString().split('T')[0]}" required>
                        </div>
                        <button type="submit" class="w-full bg-violet-600 text-white font-bold py-4 px-4 rounded-lg hover:bg-violet-700 transition-transform duration-200 transform hover:-translate-y-1 shadow-md">Add Transaction</button>
                    </form>
                </div>
            `;
            // Add form submission listener
            document.getElementById('add-transaction-form').addEventListener('submit', handleAddTransaction);
        }

        function renderScanPage() {
            document.getElementById('scan-page').innerHTML = `
                <div class="max-w-2xl mx-auto text-center">
                    <h2 class="text-2xl font-bold mb-4">Scan Receipt</h2>
                    <p class="text-slate-500 mb-8">Center your receipt in the frame below and click the scan button.</p>
                    <div class="relative aspect-video bg-slate-800 rounded-2xl overflow-hidden mb-6 flex items-center justify-center p-4">
                        <div class="absolute inset-4 border-2 border-dashed border-slate-400 rounded-xl scan-overlay-animation"></div>
                         <div class="z-10 text-slate-300 flex flex-col items-center">
                            <span class="material-symbols-outlined text-6xl">document_scanner</span>
                            <p>Camera view</p>
                        </div>
                    </div>
                    <button id="scan-btn" class="bg-violet-600 text-white font-bold py-4 px-8 rounded-lg hover:bg-violet-700 transition-transform duration-200 transform hover:-translate-y-1 shadow-md inline-flex items-center gap-2">
                        <span class="material-symbols-outlined">camera</span>
                        Start Scan
                    </button>
                </div>
            `;
            document.getElementById('scan-btn').addEventListener('click', handleScan);
        }

        function renderBudgetPage() {
            const spentByCategory = transactions
                .filter(t => t.type === 'expense')
                .reduce((acc, t) => {
                    if (!acc[t.category]) {
                        acc[t.category] = 0;
                    }
                    acc[t.category] += t.amount;
                    return acc;
                }, {});
            
            const budgetListHTML = Object.keys(budgets).length > 0 ? Object.values(budgets).map(budget => {
                const spent = spentByCategory[budget.name] || 0;
                const remaining = budget.amount - spent;
                const percentage = Math.min(Math.floor((spent / budget.amount) * 100), 100);
                const progressBarColor = percentage > 90 ? 'bg-red-500' : percentage > 70 ? 'bg-amber-500' : 'bg-violet-500';

                return `
                    <div class="bg-white p-5 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-2">
                            <p class="font-semibold text-lg">${CATEGORIES[budget.name]?.icon || '❓'} ${budget.name}</p>
                            <p class="font-bold">${percentage}%</p>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2.5 mb-2">
                            <div class="${progressBarColor} h-2.5 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                        <div class="flex justify-between items-center text-sm text-slate-500">
                            <span>Spent: ${spent.toLocaleString()}</span>
                            <span>Budget: ${budget.amount.toLocaleString()}</span>
                        </div>
                    </div>
                `;
            }).join('') : '<p class="text-center text-slate-500 py-8">No budgets set up. Go to settings to create them.</p>';

            document.getElementById('budget-page').innerHTML = `
                <h2 class="text-2xl font-bold mb-6">Your Budgets</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    ${budgetListHTML}
                </div>
            `;
        }

        // --- EVENT HANDLERS & LOGIC ---
        async function handleAddTransaction(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const category = formData.get('category');
            
            if (!category) {
                showModal('Error', '<p>Please select a category for your transaction.</p>');
                return;
            }

            const transactionData = {
                amount: parseFloat(formData.get('amount')),
                description: formData.get('description'),
                category: category,
                date: Timestamp.fromDate(new Date(formData.get('date'))),
                type: CATEGORIES[category]?.type || 'expense'
            };

            try {
                const transactionsPath = `/artifacts/${appId}/users/${userId}/transactions`;
                await addDoc(collection(db, transactionsPath), transactionData);
                showModal('Success!', '<p>Your transaction has been added successfully.</p>');
                showPage('home');
            } catch (error) {
                console.error("Error adding document: ", error);
                showModal('Error', `<p>There was an issue saving your transaction. Please try again.</p><p class="text-xs text-slate-400 mt-2">${error.message}</p>`);
            }
        }
        
        function handleScan() {
             showModal('Scanning...', `
                <div class="text-center">
                    <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-violet-600 mx-auto"></div>
                    <p class="mt-4 text-slate-600">Analyzing receipt, please wait...</p>
                </div>
            `, false); // show without close button
            
            setTimeout(() => {
                const randomAmount = (Math.random() * 5000 + 500).toFixed(2);
                const randomCategory = Object.keys(CATEGORIES).filter(c => CATEGORIES[c].type === 'expense')[Math.floor(Math.random() * 6)];

                // Close the "scanning" modal
                document.getElementById('modal').classList.add('hidden');
                
                // Prefill the add page with scanned data
                showPage('add', {
                    amount: randomAmount,
                    description: 'Scanned Receipt Item',
                    category: randomCategory,
                    date: new Date().toISOString().split('T')[0]
                });

            }, 2500);
        }

        // --- UTILITY FUNCTIONS ---
        function showPage(pageName, data = {}) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            
            // Deactivate all nav items
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            // Activate the selected page and nav item
            const pageId = `${pageName}-page`;
            const pageElement = document.getElementById(pageId);
            const navElement = document.querySelector(`.nav-item[onclick="showPage('${pageName}')"]`);

            if (pageElement) {
                pageElement.classList.add('active');
                if(pageName === 'home') renderHomePage();
                else if(pageName === 'add') renderAddPage(data);
                else if(pageName === 'scan') renderScanPage();
                else if(pageName === 'budget') renderBudgetPage();
            }
            if(navElement) navElement.classList.add('active');

            // Update header title
            const title = pageName.charAt(0).toUpperCase() + pageName.slice(1).replace(/([A-Z])/g, ' $1').trim();
            document.getElementById('page-title').textContent = title === 'Add' ? 'Add Transaction' : title;
        }
        window.showPage = showPage;

        function showModal(title, content, showCloseButton = true) {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">${title}</h2>
                    ${showCloseButton ? '<button id="modal-close-btn" class="text-slate-500 hover:text-slate-800">&times;</button>' : ''}
                </div>
                <div>${content}</div>
            `;
            modal.classList.remove('hidden');

            if(showCloseButton) {
                document.getElementById('modal-close-btn').addEventListener('click', () => {
                    modal.classList.add('hidden');
                });
            }
        }
        
        // --- START THE APP ---
        document.addEventListener('DOMContentLoaded', initializeFirebase);

    </script>
</body>
</html>
